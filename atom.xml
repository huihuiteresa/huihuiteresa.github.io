<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>huihui&#39;s blog</title>
  <icon>https://www.gravatar.com/avatar/583b30761ca997c58221e236b9e1fa54</icon>
  <subtitle>写点博客记录记录……</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://huihuiteresa.github.io/"/>
  <updated>2020-08-31T13:51:27.082Z</updated>
  <id>https://huihuiteresa.github.io/</id>
  
  <author>
    <name>小辉辉</name>
    <email>huihui_teresa@163.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>添加log4net日志</title>
    <link href="https://huihuiteresa.github.io/WebApi/log4net/"/>
    <id>https://huihuiteresa.github.io/WebApi/log4net/</id>
    <published>2020-08-31T13:22:10.191Z</published>
    <updated>2020-08-31T13:51:27.082Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ASP-NET-日志相关工具类"><a href="#ASP-NET-日志相关工具类" class="headerlink" title="ASP.NET 日志相关工具类"></a>ASP.NET 日志相关工具类</h3><p>LoggerHelper.cs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Web;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD.Logs</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 日志帮助类</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class LoggerHelper</span><br><span class="line">    &#123;</span><br><span class="line">        private static readonly log4net.ILog LogInfo &#x3D; log4net.LogManager.GetLogger(&quot;LogInfo&quot;);</span><br><span class="line"> </span><br><span class="line">        private static readonly log4net.ILog LogError &#x3D; log4net.LogManager.GetLogger(&quot;LogError&quot;);</span><br><span class="line"> </span><br><span class="line">        private static readonly log4net.ILog LogMonitor &#x3D; log4net.LogManager.GetLogger(&quot;LogMonitor&quot;);</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 记录Error日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;errorMsg&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ex&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public static void Error(string errorMsg, Exception ex &#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            if (ex !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                LogError.Error(errorMsg, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                LogError.Error(errorMsg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 记录Info日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;msg&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ex&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public static void Info(string msg, Exception ex &#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            if (ex !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                LogInfo.Info(msg, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                LogInfo.Info(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 记录Monitor日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;msg&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public static void Monitor(string msg)</span><br><span class="line">        &#123;</span><br><span class="line">            LogMonitor.Info(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MonitorLog.cs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Collections.Specialized;</span><br><span class="line">using System.Diagnostics;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Web;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD.Logs</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 监控日志对象</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class MonitorLog</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 构造函数</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public MonitorLog()</span><br><span class="line">        &#123;</span><br><span class="line">            this.Watch &#x3D; new Stopwatch();</span><br><span class="line">            this.Watch.Start();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 监控类型</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public enum MonitorType</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">            &#x2F;&#x2F;&#x2F; Action</span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">            Action &#x3D; 1,</span><br><span class="line"> </span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">            &#x2F;&#x2F;&#x2F; 视图</span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">            View &#x3D; 2</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public string ControllerName &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public string ActionName &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public Stopwatch Watch &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public DateTime ExecuteStartTime &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public DateTime ExecuteEndTime &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Form 表单数据</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public NameValueCollection FormCollections &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; URL 参数</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public NameValueCollection QueryCollections &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 文本流</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public string Raw &#123; get; set; &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 获取监控指标日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;mtype&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        public string GetLogInfo(MonitorType mtype &#x3D; MonitorType.Action)</span><br><span class="line">        &#123;</span><br><span class="line">            this.Watch.Stop();</span><br><span class="line">            string actionView &#x3D; &quot;Action执行时间监控：&quot;;</span><br><span class="line">            string action &#x3D; &quot;Action&quot;;</span><br><span class="line">            if (mtype &#x3D;&#x3D; MonitorType.View)</span><br><span class="line">            &#123;</span><br><span class="line">                actionView &#x3D; &quot;View视图生成时间监控：&quot;;</span><br><span class="line">                action &#x3D; &quot;View&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            string msgContent &#x3D; string.Format(@&quot;&#123;0&#125;ControllerName：&#123;1&#125;Controller &#123;2&#125;Name:&#123;3&#125; 开始时间：&#123;4&#125;  结束时间：&#123;5&#125; 总 时 间：&#123;6&#125;秒&quot;,</span><br><span class="line">                actionView,</span><br><span class="line">                this.ControllerName,</span><br><span class="line">                action,</span><br><span class="line">                this.ActionName,</span><br><span class="line">                this.ExecuteStartTime,</span><br><span class="line">                this.ExecuteEndTime,</span><br><span class="line">                this.Watch.ElapsedMilliseconds);</span><br><span class="line"> </span><br><span class="line">            if (!string.IsNullOrEmpty(this.Raw))</span><br><span class="line">            &#123;</span><br><span class="line">                msgContent +&#x3D; @&quot;</span><br><span class="line">        Raw：&quot; + this.Raw;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (this.FormCollections !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                msgContent +&#x3D; @&quot;</span><br><span class="line">        Form：&quot; + this.GetCollections(this.FormCollections);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (this.QueryCollections !&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                msgContent +&#x3D; @&quot;</span><br><span class="line">        Query：&quot; + this.GetCollections(this.QueryCollections);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            return msgContent;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 获取Post 或Get 参数</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;collections&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        public string GetCollections(NameValueCollection collections)</span><br><span class="line">        &#123;</span><br><span class="line">            string parameters &#x3D; string.Empty;</span><br><span class="line">            if (collections &#x3D;&#x3D; null || collections.Count &#x3D;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                return parameters;</span><br><span class="line">            &#125;</span><br><span class="line">            parameters &#x3D; collections.Keys.Cast&lt;string&gt;()</span><br><span class="line">                .Aggregate(parameters, (current, key) &#x3D;&gt; current + string.Format(&quot;&#123;0&#125;&#x3D;&#123;1&#125;&amp;&quot;, key, collections[key]));</span><br><span class="line">            if (!string.IsNullOrWhiteSpace(parameters) &amp;&amp; parameters.EndsWith(&quot;&amp;&quot;))</span><br><span class="line">            &#123;</span><br><span class="line">                parameters &#x3D; parameters.Substring(0, parameters.Length - 1);</span><br><span class="line">            &#125;</span><br><span class="line">            return parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>TrackerFilter.cs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Globalization;</span><br><span class="line">using System.Web.Mvc;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD.Logs</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 跟踪过滤器</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple &#x3D; false)]</span><br><span class="line">    public class TrackerFilter : System.Web.Mvc.ActionFilterAttribute,System.Web.Mvc.IActionFilter,System.Web.Mvc.IResultFilter,System.Web.Mvc.IExceptionFilter</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly string key &#x3D; &quot;_thisOnActionMonitorLog_&quot;;</span><br><span class="line"> </span><br><span class="line">        #region Action时间监控</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnActionExecuting</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnActionExecuting(ActionExecutingContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; new MonitorLog();</span><br><span class="line">            monLog.ExecuteStartTime &#x3D; Convert.ToDateTime(DateTime.Now.ToString(&quot;yyyy&#x2F;MM&#x2F;dd HH:mm:ss.ffff&quot;, DateTimeFormatInfo.InvariantInfo));</span><br><span class="line">            monLog.ControllerName &#x3D; filterContext.RouteData.Values[&quot;controller&quot;] as string;</span><br><span class="line">            monLog.ActionName &#x3D; filterContext.RouteData.Values[&quot;action&quot;] as string;</span><br><span class="line">            filterContext.Controller.ViewData[this.key] &#x3D; monLog;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnActionExecuted</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnActionExecuted(ActionExecutedContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteEndTime &#x3D; DateTime.Now;</span><br><span class="line">            monLog.FormCollections &#x3D; filterContext.HttpContext.Request.Form;&#x2F;&#x2F;form表单提交的数据</span><br><span class="line">            monLog.QueryCollections &#x3D; filterContext.HttpContext.Request.QueryString;&#x2F;&#x2F;Url 参数</span><br><span class="line">            LoggerHelper.Monitor(monLog.GetLogInfo());</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line"> </span><br><span class="line">        #region View 视图生成时间监控</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnResultExecuting</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnResultExecuting(ResultExecutingContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteStartTime &#x3D; DateTime.Now;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnResultExecuted</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnResultExecuted(ResultExecutedContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteEndTime &#x3D; DateTime.Now;</span><br><span class="line">            LoggerHelper.Monitor(monLog.GetLogInfo(MonitorLog.MonitorType.View));</span><br><span class="line">            filterContext.Controller.ViewData.Remove(this.key);</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line"> </span><br><span class="line">        #region 错误日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnException</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void OnException(ExceptionContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            if (!filterContext.ExceptionHandled)</span><br><span class="line">            &#123;</span><br><span class="line">                string controllerName &#x3D; string.Format(&quot;&#123;0&#125;Controller&quot;, filterContext.RouteData.Values[&quot;controller&quot;] as string);</span><br><span class="line">                string actionName &#x3D; filterContext.RouteData.Values[&quot;action&quot;] as string;</span><br><span class="line">                string errorMsg &#x3D; string.Format(&quot;在执行 controller[&#123;0&#125;] 的 action[&#123;1&#125;] 时产生异常&quot;, controllerName, actionName);</span><br><span class="line">                LoggerHelper.Error(errorMsg, filterContext.Exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnAuthorization</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void OnAuthorization(AuthorizationContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            这个方法是在Action执行之前调用</span><br><span class="line">            &#x2F;&#x2F;var user &#x3D; filterContext.HttpContext.Session[&quot;userName&quot;];</span><br><span class="line">            &#x2F;&#x2F;if (user &#x3D;&#x3D; null)</span><br><span class="line">            &#x2F;&#x2F;&#123;</span><br><span class="line">            &#x2F;&#x2F;    &#x2F;&#x2F;filterConetext.HttpContext.Response.Redirect(&quot;&#x2F;Login&#x2F;index&quot;);</span><br><span class="line">            &#x2F;&#x2F;    var url &#x3D; new UrlHelper(filterContext.RequestContext);</span><br><span class="line">            &#x2F;&#x2F;    var urls &#x3D; url.Action(&quot;Index&quot;, &quot;Login&quot;);</span><br><span class="line">            &#x2F;&#x2F;    filterContext.Result &#x3D; new RedirectResult(urls);</span><br><span class="line">            &#x2F;&#x2F;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ApiTrackerFilter.cs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Globalization;</span><br><span class="line">using System.Web.Mvc;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD.Logs</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; API过滤器</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple &#x3D; false)]</span><br><span class="line">    public class ApiTrackerFilter : System.Web.Mvc.ActionFilterAttribute, System.Web.Mvc.IActionFilter, System.Web.Mvc.IResultFilter, System.Web.Http.Filters.IFilter</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly string key &#x3D; &quot;_thisOnApiActionMonitorLog_&quot;;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        #region Action时间监控</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnActionExecuting</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnActionExecuting(ActionExecutingContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; new MonitorLog();</span><br><span class="line">            monLog.ExecuteStartTime &#x3D; Convert.ToDateTime(DateTime.Now.ToString(&quot;yyyy&#x2F;MM&#x2F;dd HH:mm:ss.ffff&quot;, DateTimeFormatInfo.InvariantInfo));</span><br><span class="line">            monLog.ControllerName &#x3D; filterContext.RouteData.Values[&quot;controller&quot;] as string;</span><br><span class="line">            monLog.ActionName &#x3D; filterContext.RouteData.Values[&quot;action&quot;] as string;</span><br><span class="line">            filterContext.Controller.ViewData[this.key] &#x3D; monLog;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnActionExecuted</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnActionExecuted(ActionExecutedContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteEndTime &#x3D; DateTime.Now;</span><br><span class="line">            monLog.FormCollections &#x3D; filterContext.HttpContext.Request.Form;&#x2F;&#x2F;form表单提交的数据</span><br><span class="line">            monLog.QueryCollections &#x3D; filterContext.HttpContext.Request.QueryString;&#x2F;&#x2F;Url 参数</span><br><span class="line">            LoggerHelper.Monitor(monLog.GetLogInfo());</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line"> </span><br><span class="line">        #region View 视图生成时间监控</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnResultExecuting</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnResultExecuting(ResultExecutingContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteStartTime &#x3D; DateTime.Now;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnResultExecuted</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public override void OnResultExecuted(ResultExecutedContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            MonitorLog monLog &#x3D; filterContext.Controller.ViewData[this.key] as MonitorLog;</span><br><span class="line">            monLog.ExecuteEndTime &#x3D; DateTime.Now;</span><br><span class="line">            LoggerHelper.Monitor(monLog.GetLogInfo(MonitorLog.MonitorType.View));</span><br><span class="line">            filterContext.Controller.ViewData.Remove(this.key);</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line"> </span><br><span class="line">        #region 错误日志</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnException</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void OnException(ExceptionContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            if (!filterContext.ExceptionHandled)</span><br><span class="line">            &#123;</span><br><span class="line">                string controllerName &#x3D; string.Format(&quot;&#123;0&#125;Controller&quot;, filterContext.RouteData.Values[&quot;controller&quot;] as string);</span><br><span class="line">                string actionName &#x3D; filterContext.RouteData.Values[&quot;action&quot;] as string;</span><br><span class="line">                string errorMsg &#x3D; string.Format(&quot;在执行 controller[&#123;0&#125;] 的 action[&#123;1&#125;] 时产生异常&quot;, controllerName, actionName);</span><br><span class="line">                LoggerHelper.Error(errorMsg, filterContext.Exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; OnAuthorization</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filterContext&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void OnAuthorization(AuthorizationContext filterContext)</span><br><span class="line">        &#123;</span><br><span class="line">            这个方法是在Action执行之前调用</span><br><span class="line">            &#x2F;&#x2F;var user &#x3D; filterContext.HttpContext.Session[&quot;userName&quot;];</span><br><span class="line">            &#x2F;&#x2F;if (user &#x3D;&#x3D; null)</span><br><span class="line">            &#x2F;&#x2F;&#123;</span><br><span class="line">            &#x2F;&#x2F;    &#x2F;&#x2F;filterConetext.HttpContext.Response.Redirect(&quot;&#x2F;Login&#x2F;index&quot;);</span><br><span class="line">            &#x2F;&#x2F;    var url &#x3D; new UrlHelper(filterContext.RequestContext);</span><br><span class="line">            &#x2F;&#x2F;    var urls &#x3D; url.Action(&quot;Index&quot;, &quot;Login&quot;);</span><br><span class="line">            &#x2F;&#x2F;    filterContext.Result &#x3D; new RedirectResult(urls);</span><br><span class="line">            &#x2F;&#x2F;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ASP-NET相关设置"><a href="#ASP-NET相关设置" class="headerlink" title="ASP.NET相关设置"></a>ASP.NET相关设置</h3><p>在Global.asax文件中添加读取日志的配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">using JT1078Server;</span><br><span class="line">using log4net.Config;</span><br><span class="line">using RedisHelp;</span><br><span class="line">using System.Web.Http;</span><br><span class="line">using System.Web.Mvc;</span><br><span class="line">using System.Web.Optimization;</span><br><span class="line">using System.Web.Routing;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 全局启动类</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class WebApiApplication : System.Web.HttpApplication</span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Redis帮助类初始化</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public static RedisHelper RedisHelper &#x3D; new RedisHelper();</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 音视频服务</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        public static Task TaskService &#x3D; new Task();</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 启动web程序</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        protected void Application_Start()</span><br><span class="line">        &#123;</span><br><span class="line">            AreaRegistration.RegisterAllAreas();</span><br><span class="line">            GlobalConfiguration.Configure(WebApiConfig.Register);</span><br><span class="line">            FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">            RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">            BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line">            &#x2F;&#x2F;应用程序启动时，自动加载配置log4Net</span><br><span class="line">            log4net.Config.XmlConfigurator.Configure();</span><br><span class="line">            GlobalConfiguration.Configuration.Filters.Add(new Logs.ApiTrackerFilter());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时还需要修改FilterConfig类，添加注册过滤器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">using System.Web;</span><br><span class="line">using System.Web.Mvc;</span><br><span class="line"> </span><br><span class="line">namespace RTVSApiFD</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 过滤器配置</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class FilterConfig</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 注册全局过滤器</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filters&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public static void RegisterGlobalFilters(GlobalFilterCollection filters)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;API日志</span><br><span class="line">            filters.Add(new Logs.ApiTrackerFilter());</span><br><span class="line">            &#x2F;&#x2F;监控日志</span><br><span class="line">            filters.Add(new Logs.TrackerFilter());</span><br><span class="line"> </span><br><span class="line">            filters.Add(new HandleErrorAttribute());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改web.config文件加入日志配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configSections</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">"log4net"</span> <span class="attr">type</span>=<span class="string">"log4net.Config.Log4NetConfigurationSectionHandler,log4net"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configSections</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">log4net</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--错误日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"RollingLogFileAppender"</span> <span class="attr">type</span>=<span class="string">"log4net.Appender.RollingFileAppender"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">file</span> <span class="attr">value</span>=<span class="string">"log\\LogError\\"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appendToFile</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">rollingStyle</span> <span class="attr">value</span>=<span class="string">"Date"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">datePattern</span> <span class="attr">value</span>=<span class="string">"yyyy\\yyyyMM\\yyyyMMdd'.txt'"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">staticLogFileName</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"MaxSizeRollBackups"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">"log4net.Layout.PatternLayout"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--每条日志末尾的文字说明--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输出格式--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--样例：2008-03-26 13:42:32,111 [10] INFO  Log4NetDemo.MainClass [(null)] - info--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conversionPattern</span> <span class="attr">value</span>=<span class="string">"%newline %n记录时间：%date %n线程ID:[%thread] %n日志级别：  %-5level %n错误描述：%message%newline %n"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!--Info日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"InfoAppender"</span> <span class="attr">type</span>=<span class="string">"log4net.Appender.RollingFileAppender"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"File"</span> <span class="attr">value</span>=<span class="string">"Log\\LogInfo\\"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"AppendToFile"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"MaxFileSize"</span> <span class="attr">value</span>=<span class="string">"10240"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"MaxSizeRollBackups"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"StaticLogFileName"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"DatePattern"</span> <span class="attr">value</span>=<span class="string">"yyyy\\yyyyMM\\yyyyMMdd'.txt'"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"RollingStyle"</span> <span class="attr">value</span>=<span class="string">"Date"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">"log4net.Layout.PatternLayout"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conversionPattern</span> <span class="attr">value</span>=<span class="string">"%newline %n记录时间：%date %n线程ID:[%thread] %n日志级别：  %-5level %n日志描述：%message%newline %n"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!--监控日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"MonitorAppender"</span> <span class="attr">type</span>=<span class="string">"log4net.Appender.RollingFileAppender"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"File"</span> <span class="attr">value</span>=<span class="string">"Log\\LogMonitor\\"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"AppendToFile"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"MaxFileSize"</span> <span class="attr">value</span>=<span class="string">"10240"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"MaxSizeRollBackups"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"StaticLogFileName"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"DatePattern"</span> <span class="attr">value</span>=<span class="string">"yyyy\\yyyyMM\\yyyyMMdd'.txt'"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"RollingStyle"</span> <span class="attr">value</span>=<span class="string">"Date"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">"log4net.Layout.PatternLayout"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conversionPattern</span> <span class="attr">value</span>=<span class="string">"%newline %n记录时间：%date %n线程ID:[%thread] %n日志级别：  %-5level %n跟踪描述：%message%newline %n"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!--Error日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"LogError"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"ERROR"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"RollingLogFileAppender"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!--Info日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"LogInfo"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"INFO"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"InfoAppender"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!--监控日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"LogMonitor"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"Monitor"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"MonitorAppender"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">log4net</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="测试ASP-NET日志输出"><a href="#测试ASP-NET日志输出" class="headerlink" title="测试ASP.NET日志输出"></a>测试ASP.NET日志输出</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[HttpPost]</span><br><span class="line">      public Result MultiSIMAlarmForJsonParam(FileSourceMultiRequest fileSourceMultiRequest)</span><br><span class="line">      &#123;</span><br><span class="line">          Result result &#x3D; null;</span><br><span class="line">          try</span><br><span class="line">          &#123;</span><br><span class="line">              if (fileSourceMultiRequest !&#x3D; null)</span><br><span class="line">              &#123;</span><br><span class="line">                  LoggerHelper.Monitor(&quot;MultiSIMAlarmForJsonParam:&quot; + fileSourceMultiRequest.ToJson());</span><br><span class="line">                  LoggerHelper.Info(&quot;MultiSIMAlarmForJsonParam:&quot; + fileSourceMultiRequest.ToJson());</span><br><span class="line">                  List&lt;AVInfo&gt; list &#x3D; cache.QueryMulti(fileSourceMultiRequest.Sims, fileSourceMultiRequest.Channel, fileSourceMultiRequest.Alarms, fileSourceMultiRequest.StorageType, fileSourceMultiRequest.StreamType, fileSourceMultiRequest.StartTime.DateTimeToUNIX_long(), fileSourceMultiRequest.EndTime.DateTimeToUNIX_long(),fileSourceMultiRequest.DataType);</span><br><span class="line">                  LoggerHelper.Info(&quot;MultiSIMAlarmForJsonParam:list.size&#x3D;&quot; + (list &#x3D;&#x3D; null ? 0 : list.Count));</span><br><span class="line">                  if (list !&#x3D; null)</span><br><span class="line">                  &#123;</span><br><span class="line">                      result &#x3D; new Result(1, &quot;查询成功!&quot;, list);</span><br><span class="line">                  &#125;</span><br><span class="line">                  else</span><br><span class="line">                  &#123;</span><br><span class="line">                      result &#x3D; new Result(0, &quot;没有查询到结果!&quot;, new List&lt;AVInfo&gt;());</span><br><span class="line">                  &#125;</span><br><span class="line">                  LoggerHelper.Info(&quot;Result&#x3D;&quot; + result.ToJson());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          catch (Exception ex)</span><br><span class="line">          &#123;</span><br><span class="line">              result &#x3D; new Result(2, &quot;异常:&quot; + ex.Message, new List&lt;AVInfo&gt;());</span><br><span class="line">              LoggerHelper.Error(&quot;MultiSIMAlarmForJsonParam异常:&quot; + result.ToJson());</span><br><span class="line">          &#125;</span><br><span class="line">          return result;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>需要在AssemblyInfo.cs文件中添加[assembly:log4net.Config.XmlConfigurator(ConfigFile=”log4net.config”,Watch=true)]</p><p>转载：<a href="https://blog.csdn.net/boonya/article/details/81189754" target="_blank" rel="noopener">https://blog.csdn.net/boonya/article/details/81189754</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ASP-NET-日志相关工具类&quot;&gt;&lt;a href=&quot;#ASP-NET-日志相关工具类&quot; class=&quot;headerlink&quot; title=&quot;ASP.NET 日志相关工具类&quot;&gt;&lt;/a&gt;ASP.NET 日志相关工具类&lt;/h3&gt;&lt;p&gt;LoggerHelper.cs&lt;/p
      
    
    </summary>
    
    
      <category term="WebApi" scheme="https://huihuiteresa.github.io/categories/WebApi/"/>
    
    
      <category term="log4net" scheme="https://huihuiteresa.github.io/tags/log4net/"/>
    
  </entry>
  
  <entry>
    <title>WebAPI全局捕获异常</title>
    <link href="https://huihuiteresa.github.io/WebAPI/webapiexception/"/>
    <id>https://huihuiteresa.github.io/WebAPI/webapiexception/</id>
    <published>2020-07-19T14:46:00.000Z</published>
    <updated>2020-07-19T14:50:11.617Z</updated>
    
    <content type="html"><![CDATA[<h3 id="WebApi异常捕获方法"><a href="#WebApi异常捕获方法" class="headerlink" title="WebApi异常捕获方法"></a>WebApi异常捕获方法</h3><ol><li>添加一个类处理: ApiErrorHandler<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class ApiErrorHandler : ExceptionFilterAttribute</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 异常处理</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;context&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">    public override void OnException(HttpActionExecutedContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        HttpResponseMessage response &#x3D; null;</span><br><span class="line"> </span><br><span class="line">        if (context.Exception is NotImplementedException)</span><br><span class="line">        &#123;</span><br><span class="line">            response &#x3D; new HttpResponseMessage(HttpStatusCode.NotImplemented);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (context.Exception is TimeoutException)</span><br><span class="line">        &#123;</span><br><span class="line">            response &#x3D; new HttpResponseMessage(HttpStatusCode.RequestTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            response &#x3D; new HttpResponseMessage(HttpStatusCode.InternalServerError);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;日志记录</span><br><span class="line">        LogHelper.Error(context.Exception.ToString());</span><br><span class="line">                 </span><br><span class="line">                &#x2F;&#x2F;可以发送邮件通知相关人员网站发生异常了</span><br><span class="line">        &#x2F;&#x2F;Helpers.SendEmail(&quot;网站异常(ApiError)&quot;, context.Exception.ToString());</span><br><span class="line"> </span><br><span class="line">        context.Response &#x3D; response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>ExceptionFilterAttribute 需要添加引用 System.Web.Http</li></ol><p>HttpResponseMessage 需要添加引用 System.Net.Http.dll</p><ol start="2"><li>在WebApiConfig内添加如下代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalConfiguration.Configuration.Filters.Add(new ApiErrorHandler());</span><br></pre></td></tr></table></figure></li></ol><p>这时候在WebApi内发生的异常都会进入这个方法</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;WebApi异常捕获方法&quot;&gt;&lt;a href=&quot;#WebApi异常捕获方法&quot; class=&quot;headerlink&quot; title=&quot;WebApi异常捕获方法&quot;&gt;&lt;/a&gt;WebApi异常捕获方法&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;添加一个类处理: ApiErrorHandler
      
    
    </summary>
    
    
      <category term="WebAPI" scheme="https://huihuiteresa.github.io/categories/WebAPI/"/>
    
    
      <category term="WebAPI捕获异常" scheme="https://huihuiteresa.github.io/tags/WebAPI%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8/"/>
    
      <category term=".NET捕获异常" scheme="https://huihuiteresa.github.io/tags/NET%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>SQLServer行转列</title>
    <link href="https://huihuiteresa.github.io/SqlServer/rowtocolumn/"/>
    <id>https://huihuiteresa.github.io/SqlServer/rowtocolumn/</id>
    <published>2020-07-01T13:24:20.000Z</published>
    <updated>2020-07-01T13:39:04.114Z</updated>
    
    <content type="html"><![CDATA[<h3 id="建表，添加测试数据"><a href="#建表，添加测试数据" class="headerlink" title="建表，添加测试数据"></a>建表，添加测试数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--删除临时表</span><br><span class="line">if object_id(&#39;tempdb..#demo&#39;) is not null</span><br><span class="line">     drop table #temp</span><br><span class="line"></span><br><span class="line">CREATE TABLE #demo(</span><br><span class="line">    row1 NVARCHAR(10),</span><br><span class="line">row2 NVARCHAR(10),</span><br><span class="line">col NVARCHAR(10),</span><br><span class="line">colval NVARCHAR(10)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO #demo (row1,row2,col,colval)VALUES( N&#39;huihui&#39;, N&#39;1&#39;,N&#39;语文&#39;, N&#39;1&#39;  );</span><br><span class="line">INSERT INTO #demo (row1,row2,col,colval)VALUES( N&#39;huihui&#39;, N&#39;1&#39;,N&#39;数学&#39;, N&#39;2&#39;  );</span><br><span class="line">INSERT INTO #demo (row1,row2,col,colval)VALUES( N&#39;huihui&#39;, N&#39;1&#39;,N&#39;英语&#39;, N&#39;3&#39;  );</span><br><span class="line">INSERT INTO #demo (row1,row2,col,colval)VALUES( N&#39;huihui&#39;, N&#39;2&#39;,N&#39;英语&#39;, N&#39;3&#39;  );</span><br><span class="line">INSERT INTO #demo (row1,row2,col,colval)VALUES( N&#39;haha&#39;, N&#39;2&#39;,N&#39;英语&#39;, N&#39;3&#39;  );</span><br></pre></td></tr></table></figure><h3 id="行转列sql"><a href="#行转列sql" class="headerlink" title="行转列sql"></a>行转列sql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--sql</span><br><span class="line">declare  @col varchar(3000)&#x3D;&#39;&#39;, @selCol VARCHAR(3000)&#x3D;&#39;&#39;,@sql varchar(3000)&#x3D;&#39;&#39;;</span><br><span class="line">select @col&#x3D;@col+&#39;,[&#39;+[col]+&#39;]&#39;  from (select distinct [col] from #demo) a order by [col];</span><br><span class="line">select @selCol&#x3D;@selCol+&#39;,max([&#39;+[col]+&#39;]) as &#39;+&#39;[&#39;+[col]+&#39;]&#39;  from (select distinct [col] from #demo) a order by [col];</span><br><span class="line">select  @col&#x3D;right(@col,len(@col)-1);</span><br><span class="line">select  @selCol&#x3D;right(@selCol,len(@selCol)-1);</span><br><span class="line"></span><br><span class="line">set @sql&#x3D;&#39;select row1,row2,&#39;+@selCol+</span><br><span class="line">&#39; from( select row1,row2,&#39;+@col +&#39;from #demo a  </span><br><span class="line">pivot (max(colval) for col in(&#39;+@col+&#39;) </span><br><span class="line">) as pv ) b group by row1,row2&#39;;</span><br><span class="line">exec(@sql);</span><br></pre></td></tr></table></figure><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>需要分组情况，网上找的大部分都是不带group by的，记录下。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;建表，添加测试数据&quot;&gt;&lt;a href=&quot;#建表，添加测试数据&quot; class=&quot;headerlink&quot; title=&quot;建表，添加测试数据&quot;&gt;&lt;/a&gt;建表，添加测试数据&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t
      
    
    </summary>
    
    
      <category term="SqlServer" scheme="https://huihuiteresa.github.io/categories/SqlServer/"/>
    
    
      <category term="行转列" scheme="https://huihuiteresa.github.io/tags/%E8%A1%8C%E8%BD%AC%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>设计模式原则</title>
    <link href="https://huihuiteresa.github.io/designpatterns/principle/"/>
    <id>https://huihuiteresa.github.io/designpatterns/principle/</id>
    <published>2020-06-22T00:23:16.000Z</published>
    <updated>2020-06-22T00:32:01.044Z</updated>
    
    <content type="html"><![CDATA[<h3 id="架构中的设计原则"><a href="#架构中的设计原则" class="headerlink" title="架构中的设计原则"></a>架构中的设计原则</h3><p><strong>单一职责原则</strong>：系统中的每一个对象都应该只有一个单独的职责，而所有对象所关注的就是自身职责的完成。</p><p><strong>里氏替换原则</strong>：在任何父类出现的地方都可以用它的子类来替换。</p><ol><li>子类必须完全实现父类的方法</li><li>子类可以有自己的特性</li><li>覆盖或者实现父类的方法时输入参数可以被放大</li><li>覆写或者实现父类的方法时输出结果可以被缩小。</li></ol><p><strong>依赖注入原则（依赖反转原则）</strong>：要依赖于抽象，不要依赖于具体的实现。</p><p>三点说明：</p><ol><li>高层模块不应该依赖低层模块，两者都应该依赖于抽象（抽象类或接口）</li><li>抽象（抽象类或接口）不应该依赖于细节（具体实现类）</li><li>细节（具体实现类）应该依赖抽象</li></ol><p>实现方式：</p><ol><li>通过构造函数传递依赖对象</li><li>通过setter方法传递依赖对象</li><li>接口声明实现依赖对象</li></ol><p><strong>接口分离原则</strong>：不应该强迫客户程序依赖它们不需要使用的方法。</p><p><strong>迪米特原则</strong>：一个对象应当对其他对象尽可能少的了解。</p><p><strong>开闭原则</strong>：一个对象对扩展开放，对修改关闭。</p><p><strong>合成复用原则</strong>：尽量使用合成/聚合的方式，而不是使用继承。</p><h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><ol><li>接口的思想就是“封装隔离”</li><li>接口与抽象类的选择<ul><li>优先使用接口；</li><li>在既要定义子类行为，又要为子类提供公共的功能时应选择抽象类；</li></ul></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;架构中的设计原则&quot;&gt;&lt;a href=&quot;#架构中的设计原则&quot; class=&quot;headerlink&quot; title=&quot;架构中的设计原则&quot;&gt;&lt;/a&gt;架构中的设计原则&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;单一职责原则&lt;/strong&gt;：系统中的每一个对象都应该只有一个单独的职责，
      
    
    </summary>
    
    
      <category term="设计模式" scheme="https://huihuiteresa.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式原则" scheme="https://huihuiteresa.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8E%9F%E5%88%99/"/>
    
      <category term="设计模式" scheme="https://huihuiteresa.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
</feed>
